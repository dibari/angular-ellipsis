angular.module("dibari.angular-ellipsis",[]).directive("ellipsis",["$timeout","$window","$sce",function(e,i,n){var t=function(i){var n=null,t=[];this.remove=function(i){-1!==t.indexOf(i)&&(t.splice(t.indexOf(i),1),0===t.length&&(e.cancel(n),n=null))},this.add=function(l){-1===t.indexOf(l)&&t.push(l),n||(n=e(function(){var e=t.slice();n=null,t.length=0,e.forEach(function(e){e()})},i))}},l=new t(0),s=new t(75);return{restrict:"A",scope:{ngShow:"=",ngBind:"=",ngBindHtml:"=",ellipsisAppend:"@",ellipsisAppendClick:"&",ellipsisSymbol:"@",ellipsisSeparator:"@",useParent:"@",ellipsisUseParent:"@",ellipsisSeparatorReg:"=",ellipsisMaxLines:"@",ellipsisFallbackFontSize:"@"},compile:function(e,t,a){return function(e,t,a){function r(e){return"undefined"!=typeof e}function d(e){var i=0;return angular.forEach(e.parent().children(),function(n){n!=e[0]&&(i+=n.clientHeight)}),e.parent()[0].clientHeight-i}function o(){var i=e.ngBind||e.ngBindHtml,l=!1;if(n.isEnabled()&&angular.isObject(i)&&n.getTrustedHtml(i)&&(l=!0,i=n.getTrustedHtml(i)),i){var s=!e.ngBind&&!!e.ngBindHtml,o=a.ellipsisUseParent||a.useParent,f=a.ellipsisMaxLines,h="undefined"!=typeof a.ellipsisSymbol?a.ellipsisSymbol:"&hellip;",g="undefined"!=typeof a.ellipsisSeparator?a.ellipsisSeparator:" ",m="undefined"!=typeof a.ellipsisSeparatorReg?a.ellipsisSeparatorReg:new RegExp("["+g+"]+","gm"),w="undefined"!=typeof a.ellipsisAppend&&""!==a.ellipsisAppend?h+"<span class='angular-ellipsis-append'>"+a.ellipsisAppend+"</span>":h;if(s?t.html(i):t.text(i),r(e.ellipsisFallbackFontSize)&&c(t,o)&&t.css("font-size",e.ellipsisFallbackFontSize),f){var v=t[0].style.display;t[0].style.display="inline";var H=t[0].getBoundingClientRect(),y=t[0].getClientRects(),b=Math.ceil(H.height/y.length);t[0].style.display=v,t[0].style.maxHeight=b*e.ellipsisMaxLines+"px"}if(c(t,o)){t.attr("data-overflowed","true");for(var S=o?d(t):t[0].clientHeight,W=[];null!=(match=m.exec(i));)W.push(match.index);if(0===W.length){for(var x=minimumTruncateLength=5;x<=i.length;)W.push(x),x=2*x;W.push(i.length)}for(var z,R=0,$=W.length-1;;){z=R+($-R>>1);var A=u(t,p(i,W,z)+w,S);if($-R===1)break;A?$=z:R=z}a.isTruncated=!0,s?t.html(p(i,W,z)+w):t.text(p(i,W,z)).html(t.html()+w),h!=w&&"undefined"!=typeof e.ellipsisAppendClick&&""!==e.ellipsisAppendClick&&t.find("span.angular-ellipsis-append").bind("click",function(i){e.$apply(function(){e.ellipsisAppendClick.call(e,{event:i})})}),!l&&n.isEnabled()&&n.trustAsHtml(i)}else t.attr("data-overflowed","false")}}function p(e,i,n){return e.substr(0,i[n])}function u(e,i,n){return e[0].innerHTML=i,e[0].scrollHeight>n}function c(e,i){return e=i?e.parent():e,e[0].scrollHeight>e[0].clientHeight}function f(){(a.lastWindowResizeWidth!=window.innerWidth||a.lastWindowResizeHeight!=window.innerHeight)&&o(),a.lastWindowResizeWidth=window.innerWidth,a.lastWindowResizeHeight=window.innerHeight}function h(){s.add(f)}a.lastWindowResizeTime=0,a.lastWindowResizeWidth=0,a.lastWindowResizeHeight=0,a.lastWindowTimeoutEvent=null,a.isTruncated=!1,e.$watch("ngShow",function(){l.add(o)}),e.$watch("ngBind",function(){l.add(o)}),e.$watch("ngBindHtml",function(){l.add(o)}),e.$watch("ellipsisAppend",function(){o()}),e.$watch(function(){return 0!=t[0].offsetWidth&&0!=t[0].offsetHeight},function(){s.add(o)});var g=e.$on("dibari:refresh-ellipsis",function(){l.add(o)}),m=angular.element(i);m.bind("resize",h),e.$on("$destroy",function(){m.unbind("resize",h),l.remove(o),s.remove(f),g&&(g(),g=null)})}}}}]);