angular.module("dibari.angular-ellipsis",[]).directive("ellipsis",["$timeout","$window","$sce",function(a,b,c){var d=function(b){var c=null,d=[];this.remove=function(b){-1!==d.indexOf(b)&&(d.splice(d.indexOf(b),1),0===d.length&&(a.cancel(c),c=null))},this.add=function(e){-1===d.indexOf(e)&&d.push(e),c||(c=a(function(){var a=d.slice();c=null,d.length=0,a.forEach(function(a){a()})},b))}},e=new d(0),f=new d(75);return{restrict:"A",scope:{ngShow:"=",ngBind:"=",ngBindHtml:"=",ellipsisAppend:"@",ellipsisAppendClick:"&",ellipsisSymbol:"@",ellipsisSeparator:"@",useParent:"@",ellipsisSeparatorReg:"=",ellipsisFallbackFontSize:"@"},compile:function(a,d,g){return function(a,d,g){function h(a){return"undefined"!=typeof a}function i(a){var b=0;return angular.forEach(a.parent().children(),function(c){c!=a[0]&&(b+=c.clientHeight)}),a.parent()[0].clientHeight-b}function j(){var b=a.ngBind||a.ngBindHtml,e=!1;if(c.isEnabled()&&angular.isObject(b)&&c.getTrustedHtml(b)&&(e=!0,b=c.getTrustedHtml(b)),b){var f=!a.ngBind&&!!a.ngBindHtml,j=0,l="undefined"!=typeof g.ellipsisSymbol?g.ellipsisSymbol:"&hellip;",m="undefined"!=typeof a.ellipsisSeparator?g.ellipsisSeparator:" ",n="undefined"!=typeof a.ellipsisSeparatorReg?a.ellipsisSeparatorReg:!1,o="undefined"!=typeof a.ellipsisAppend&&""!==a.ellipsisAppend?l+"<span class='angular-ellipsis-append'>"+a.ellipsisAppend+"</span>":l,p=n?b.match(n):b.split(m);if(g.isTruncated=!1,f?d.html(b):d.text(b),h(g.ellipsisFallbackFontSize)&&k(d)&&d.css("font-size",g.ellipsisFallbackFontSize),k(d,a.useParent)){var q=p.length,r=a.useParent?i(d):d[0].clientHeight;for(f?d.html(b+o):d.text(b).html(d.html()+o),d.attr("data-overflowed","true"),a.$parent.$overflowFull=a.ngBind;q>j;j++){var s=p.pop();if(0===p.length&&(p[0]=s.substring(0,Math.min(s.length,5))),f?d.html(p.join(m)+o):d.text(p.join(m)).html(d.html()+o),(a.useParent?d.parent()[0]:d[0]).scrollHeight<r||k(d,a.useParent)===!1){g.isTruncated=!0;break}}l!=o&&"undefined"!=typeof a.ellipsisAppendClick&&""!==a.ellipsisAppendClick&&d.find("span.angular-ellipsis-append").bind("click",function(b){a.$apply(function(){a.ellipsisAppendClick.call(a,{event:b})})}),!e&&c.isEnabled()&&c.trustAsHtml(b)}else d.attr("data-overflowed","false"),a.$parent.$overflowFull=a.ngBind}}function k(a,b){return a=b?a.parent():a,a[0].scrollHeight>a[0].clientHeight}function l(){(g.lastWindowResizeWidth!=window.innerWidth||g.lastWindowResizeHeight!=window.innerHeight)&&j(),g.lastWindowResizeWidth=window.innerWidth,g.lastWindowResizeHeight=window.innerHeight}function m(){f.add(l)}g.lastWindowResizeTime=0,g.lastWindowResizeWidth=0,g.lastWindowResizeHeight=0,g.lastWindowTimeoutEvent=null,g.isTruncated=!1,a.$watch("ngShow",function(){e.add(j)}),a.$watch("ngBind",function(){e.add(j)}),a.$watch("ngBindHtml",function(){e.add(j)}),a.$watch("ellipsisAppend",function(){j()}),a.$watch(function(){return 0!==d[0].offsetWidth&&0!==d[0].offsetHeight},function(){f.add(j)});var n=a.$on("dibari:refresh-ellipsis",function(){e.add(j)}),o=angular.element(b);o.bind("resize",m),a.$on("$destroy",function(){o.unbind("resize",m),e.remove(j),f.remove(l),n&&(n(),n=null)})}}}}]);